<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />

<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/blog.css" type="text/css"/>

<title>不如，我们也来写php扩展？</title>
<meta name="keywords" content="php插件,php插件入门">
<meta name="description" content="php插件,php插件入门">
<script type="text/javascript">
var _speedMark = new Date();
</script>
</head>

<body>
<div class="navbar navbar-fixed-top">
  <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
        <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav ml90">
          <li data-slide="1" class="col-xs-4"><a href="/"  id="menu-link-1"><span class="glyphicon glyphicon-home"></span>首页</a></li>
          <li data-slide="2" class="col-xs-4 active"><a href="/blog/" id="menu-link-2"><span class="glyphicon glyphicon-book"></span>博客</a></li>
          <li data-slide="3" class="col-xs-4"><a href="/team/" id="menu-link-3" target="_blank"><span class="glyphicon glyphicon-user"></span>团队</a></li>
        </ul>
      <div class="row">
        <div class="col-xs-4 active-menu"></div>
      </div>
          
      </div>
    </div>
</div>
<div class="content-title"><h1 class="title glyphicon glyphicon-leaf">不如，我们也来写php扩展？<span class="view glyphicon glyphicon-eye-open"></span><span class="time glyphicon glyphicon-time"></span></h1></div>

<div class="content">
	<!---title:不如，我们也来写php扩展？-->
<!---keywords:php插件,php插件入门-->

<p>今天先写个开发php插件的入门介绍，看完演示之后还有兴趣的童鞋再等下一篇进阶。会发现入门的东西很有意思，至少让有代码之“痒”的童鞋解恨（就是范指一些急切俸hello world的demo的童鞋），其实，更应该追求一个“www”学习过程，也就是“what”，“why”，“how”。</p>
<div class="figure">
<img src="/static/images/upload/20140602120759-54.png" alt="怎样快速学习一门新技术" /><p class="caption">怎样快速学习一门新技术</p>
</div>
<p>今天先不讲过多的概念，大概的过程是这样的，要在一个已安装好的php环境里面添加一个自定义的php扩展。</p>
<div class="figure">
<img src="/static/images/upload/20140424154822-27.png" alt="开发流程" /><p class="caption">开发流程</p>
</div>
<p><strong>第一步：准备工作</strong></p>
<p>一个已经安装好的php环境（针对linux下php，当前php安装目录：/usr/local/php/）和当前php环境编译安装包（因为一会需要编译你的扩展，所以要和当前版本一致，我使用的版本是5.5.1）</p>
<p><strong>第二步：生成扩展开发文件</strong></p>
<p>切换到php编译安装包，我们的目标是：huamanshu扩展</p>
<pre><code>cd ext
./ext_skel --extname=huamanshu
/usr/local/php/bin/phpize</code></pre>
<p>如果出现<code>Cannot find autoconf. Please check your autoconf installation and the $PHP_AUTOCONF environment variable. Then, rerun this script.</code>如依此解决，刚好我是出现这样的问题了。</p>
<pre><code>wget http://ftp.gnu.org/gnu/m4/m4-1.4.9.tar.gz  
tar -zvxf m4-1.4.9.tar.gz  
cd m4-1.4.9/  
./configure --prefix=/usr/local/m4 &amp;&amp; make &amp;&amp; sudo make install  
cd ../  
wget http://ftp.gnu.org/gnu/autoconf/autoconf-2.62.tar.gz  
tar -zvxf autoconf-2.62.tar.gz  
cd autoconf-2.62/  
./configure --prefix=/usr/local/autoconf &amp;&amp; make &amp;&amp; sudo make install  
  
做个软链  
sudo ln -s /usr/local/autoconf/bin/autoheader /usr/bin/autoheader  
sudo ln -s /usr/local/autoconf/bin/autoconf /usr/bin/autoconf  
  
最后加入环境变量中  
vi /etc/profile #添加  
export PHP_AUTOCONF=/usr/bin/autoconf  
export PHP_AUTOHEADER=/usr/bin/autoheader  </code></pre>
<p>再次<code>/usr/local/php/bin/phpize</code>执行，如果没有报错则可以往下做编译了。</p>
<p><strong>第三步：简单开发</strong></p>
<pre><code>vi config.m4 #把16行和18行前面的dnl去掉
16 PHP_ARG_ENABLE(huamanshu, whether to enable huamanshu support,
17 dnl Make sure that the comment is aligned:
18 [  --enable-huamanshu           Enable huamanshu support])</code></pre>
<p><strong>第四步：编译</strong></p>
<p>需要取之前安装php的配置文件加参数 --with-php-config使得之前安装的php不被破坏，并在之前的基础上添加自定义扩展。</p>
<pre><code>./configure --with-php-config=/usr/local/php/bin/php-config
make &amp;&amp; sudo make install</code></pre>
<p><strong>第五步：修改配置</strong></p>
<p>切换到原来php环境，添加刚才编译的扩展。</p>
<pre><code>vi /usr/local/php/etc/php.ini 
添加
extension=huamanshu.so
查看是否添加成功：php -m | grep huamanshu</code></pre>
<p>由于原来huamanshu扩展在使用<code>ext_skel</code>和<code>phpize</code>快速开发的时候，已经有了一个demo方法<code>confirm_huamanshu_compiled</code>，所以现在可以做简单的扩展函数的测试</p>
<p><strong>第六步：测试</strong></p>
<pre><code>php -r &#39;echo confirm_huamanshu_compiled(&quot;==============&quot;);&#39;</code></pre>
<div class="figure">
<img src="/static/images/upload/20140424115936-91.png" alt="测试demo" /><p class="caption">测试demo</p>
</div>
<p>要知道我的博客不会只写demo如此的肤浅，请期待接下来关于类自动加载扩展开发介绍。</p>
</div>

<hr class="blog-hr">

<div class="container blog-container prev-next-box">
  <ul class="pager">
    <li class="previous"><a href="javascript:void(0);" id="prev">&larr; Older</a></li>
    <li class="next"><a href="javascript:void(0);" id="next">Newer &rarr;</a></li>
  </ul>
</div>

<div class="content" data-slide="1">
	<div class="blog-container">
		<div id="home-row-1" class="clearfix">
			<div id="comments"></div>
		</div>
	</div>
</div>

<div class="container blog-container comment-box">
		<form class="form-horizontal" role="form">
	  <div class="form-group">
	    <div class="col-sm-3">
	      <input type="text" class="form-control js-name" placeholder="名字不重要">
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <textarea class="form-control inputComment js-comment" placeholder="深有感触，写点我的想法"> </textarea>
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <button type="submit" class="btn btn-default js-submit">发表评论</button>
	    </div>
	  </div>
	</form>
</div>
<!-- <div id="blog-footer"><a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="weibo">微博</a> | <a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="glyphicon glyphicon-envelope email-footer">wushuiyong@huamanshu.com</a> </div> -->
<div id="blog-footer">©2014 huamanshu. All rights reserved</div><div class="hide" style="display:none"><script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script></div>
<script src="/static/js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="/static/js/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/static/js/script.js" type="text/javascript"></script>
<script>
$(document).ready(function(e) {
  var lis = $('.nav > li');
  menu_focus( lis[1], 1 );
  
  var sprintf = function() {
      var arg = arguments,
          str = arg[0] || '',
          i, n;
      for (i = 1, n = arg.length; i < n; i++) {
          str = str.replace(/%s/, arg[i]);
      }
      return str;
  }

  // 初始化评论
  var initComment = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getComment/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          var tpl = '';
          for (key in data.comments) {
              var c = data.comments[key];
              tpl += sprintf("<blockquote><p><em>%s</em>%s</p></blockquote>", c.name, c.comment);
          }
          $('#comments').html(tpl).show();
      }
    })
  }
  initComment();

  // 初始化浏览次数
  var initViewCount = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/viewCount/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          $('.time').text(data.time);
          $('.view').text(data.view);
      }
    });
  }
  initViewCount();

  // 获取上一篇下一篇
  var initNextPrev = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getNextPrev/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
        var re = /\/index\d.html/
        var nTitle = re.test(data.n.url) ? '下一页' : data.n.title;
        var pTitle = re.test(data.p.url) ? '上一页' : data.p.title;
        data.n ? $('#next').attr('href', data.n.url).html(nTitle + ' &rarr;') : $('#next').hide();
        data.p ? $('#prev').attr('href', data.p.url).html('&larr; ' + pTitle) : $('#prev').hide();
      }
    });
  }
  initNextPrev();

  // 写完点提交或者ctrl+enter
  if (event.ctrlKey && event.keyCode == '13') {
    addComment();
  }
  $('.js-submit').click(function(e) {
    e.preventDefault();
    addComment();
  })

  // 添加评论
  var addComment = function() {
    var name = $('.js-name').val();
    var comment = $('.js-comment').val();

    $.ajax({
      'type' : 'POST',
      'url'  : '/home/blog/addComment/',
      'data' : sprintf('name=%s&comment=%s&id=%s', encodeURIComponent(name), encodeURIComponent(comment), encodeURIComponent(window.location.href)),
      'success' : function(data) {
          initComment();
          $('.js-name').val('');
          $('.js-comment').val('');
      }
    })
  }
});

</script>
<script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script>

</body>
</html>
