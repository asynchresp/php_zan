<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />

<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/blog.css" type="text/css"/>

<title>php扩展：htable</title>
<meta name="keywords" content="php扩展">
<meta name="description" content="php扩展">
<script type="text/javascript">
var _speedMark = new Date();
</script>
</head>

<body>
<div class="navbar navbar-fixed-top">
  <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
        <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav ml90">
          <li data-slide="1" class="col-xs-4"><a href="/"  id="menu-link-1"><span class="glyphicon glyphicon-home"></span>首页</a></li>
          <li data-slide="2" class="col-xs-4 active"><a href="/blog/" id="menu-link-2"><span class="glyphicon glyphicon-book"></span>博客</a></li>
          <li data-slide="3" class="col-xs-4"><a href="/team/" id="menu-link-3" target="_blank"><span class="glyphicon glyphicon-user"></span>团队</a></li>
        </ul>
      <div class="row">
        <div class="col-xs-4 active-menu"></div>
      </div>
          
      </div>
    </div>
</div>
<div class="content-title"><h1 class="title glyphicon glyphicon-leaf">php扩展：htable<span class="view glyphicon glyphicon-eye-open"></span><span class="time glyphicon glyphicon-time"></span></h1></div>

<div class="content">
	<!---title:php扩展：htable-->
<!---keywords:php扩展-->

<p>此htbale非彼htable，这只是php扩展，用来快速获取分表的后缀。一般情况下，我们数据都可以在mysql下存储在一个表中，慢慢地，用户量上来了，数据量大了就得分表。分表策略各有想法，大多以某一字段做hash，之后做模运算，所得到的数字就是表后缀。</p>
<p>简单的一个例子：你有5000万用户，打算分10个表，把uid值hash（一般使用crc32），得到一个整数值，再模10，得到的数字即为表后缀。</p>
<pre><code>function getHashTableId($uid, $s=10) {
    $crcH = sprintf(&quot;%u&quot;, crc32($uid));
    $retHash = intval(fmod($crcH, $s)) + 1;
    return $retHash;
}</code></pre>
<p>这次要说的就是上面代码段转化为<code>htable($uid)</code>，固化为一个php方法。这样做只有一个好处，就是在某一天Robin突然过来跟我说，给我查下这uid的小三是谁的时候，我可以很潇洒的在命令行...</p>
<pre><code>$ php -r &#39;echo htable(123456);&#39; // 5
$ mysql -e &#39;select &#39;小三&#39; from user_5 where uid = 123456\G&#39;</code></pre>
<p>然后，我就顺利升职加薪当上总经理，出任CEO,迎娶白富美，走向人生巅峰。想想，还有点小激动。</p>
<p>看到这么美好的景愿，那我们开始把这货先准备好，为节省时间，只介绍上文<a href="http://www.huamanshu.com/blog/2014-04-23.html">不如，我们也来写php扩展？</a>中的第三步：对应的编码。跳过php_huamanshu.h添加htable方法，直接在huamanshu.c中实现。</p>
<pre><code>// 1.头部引进内核crc32头文件，里面已经定义好crc32数组
#include &quot;ext/standard/crc32.h&quot;
    
// 2.在 zend_function_entry huamanshu_functions 数组中添加htable方法定义（不能有逗号）
PHP_FE(htable, NULL)
  
// 3.htable方法实现
ZEND_FUNCTION(htable) {
    char *p; 
    int len, nr; 
    // php_uint32 相当于 unsigned int
    ///已经在basic_functions.h中define
    php_uint32 crcinit = 0; 
    register php_uint32 crc;
    double crc_d;
    php_uint32 per = 10;  // 分表策略为10
      
    // 以字符串形式接收参数  
    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, &quot;s&quot;, &amp;p, &amp;nr) == FAILURE) {
        return;
    }
    crc = crcinit^0xFFFFFFFF;
        
    // 每一位做hash
    for (len =+nr; nr--; ++p) {
        crc = ((crc &gt;&gt; 8) &amp; 0x00FFFFFF) ^ crc32tab[(crc ^ (*p)) &amp; 0xFF ];
    }
    crc = crc^0xFFFFFFFF;
    crc_d = (double) crc;
        
    // 模10+1
    RETURN_LONG((php_uint32)crc_d % per + 1);
}</code></pre>
<p>开发基本完成了，剩下的就是编译调试，为减少成本，把编译语句放到脚本中去，每次需要的时候<code>sh compile.sh</code>即可。</p>
<pre><code>$ vi compile.sh
#!/bin/bash
                                                                                                                                                 
./configure --with-php-config=/usr/local/php/bin/php-config
make &amp;&amp; sudo make install</code></pre>
<p>没有问题的话，剩下就是坐等大Boss的到来，嘿嘿！</p>
</div>

<hr class="blog-hr">

<div class="container blog-container prev-next-box">
  <ul class="pager">
    <li class="previous"><a href="javascript:void(0);" id="prev">&larr; Older</a></li>
    <li class="next"><a href="javascript:void(0);" id="next">Newer &rarr;</a></li>
  </ul>
</div>

<div class="content" data-slide="1">
	<div class="blog-container">
		<div id="home-row-1" class="clearfix">
			<div id="comments"></div>
		</div>
	</div>
</div>

<div class="container blog-container comment-box">
		<form class="form-horizontal" role="form">
	  <div class="form-group">
	    <div class="col-sm-3">
	      <input type="text" class="form-control js-name" placeholder="名字不重要">
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <textarea class="form-control inputComment js-comment" placeholder="深有感触，写点我的想法"> </textarea>
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <button type="submit" class="btn btn-default js-submit">发表评论</button>
	    </div>
	  </div>
	</form>
</div>
<!-- <div id="blog-footer"><a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="weibo">微博</a> | <a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="glyphicon glyphicon-envelope email-footer">wushuiyong@huamanshu.com</a> </div> -->
<div id="blog-footer">©2014 huamanshu. All rights reserved</div><div class="hide" style="display:none"><script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script></div>
<script src="/static/js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="/static/js/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/static/js/script.js" type="text/javascript"></script>
<script>
$(document).ready(function(e) {
  var lis = $('.nav > li');
  menu_focus( lis[1], 1 );
  
  var sprintf = function() {
      var arg = arguments,
          str = arg[0] || '',
          i, n;
      for (i = 1, n = arg.length; i < n; i++) {
          str = str.replace(/%s/, arg[i]);
      }
      return str;
  }

  // 初始化评论
  var initComment = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getComment/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          var tpl = '';
          for (key in data.comments) {
              var c = data.comments[key];
              tpl += sprintf("<blockquote><p><em>%s</em>%s</p></blockquote>", c.name, c.comment);
          }
          $('#comments').html(tpl).show();
      }
    })
  }
  initComment();

  // 初始化浏览次数
  var initViewCount = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/viewCount/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          $('.time').text(data.time);
          $('.view').text(data.view);
      }
    });
  }
  initViewCount();

  // 获取上一篇下一篇
  var initNextPrev = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getNextPrev/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
        var re = /\/index\d.html/
        var nTitle = re.test(data.n.url) ? '下一页' : data.n.title;
        var pTitle = re.test(data.p.url) ? '上一页' : data.p.title;
        data.n ? $('#next').attr('href', data.n.url).html(nTitle + ' &rarr;') : $('#next').hide();
        data.p ? $('#prev').attr('href', data.p.url).html('&larr; ' + pTitle) : $('#prev').hide();
      }
    });
  }
  initNextPrev();

  // 写完点提交或者ctrl+enter
  if (event.ctrlKey && event.keyCode == '13') {
    addComment();
  }
  $('.js-submit').click(function(e) {
    e.preventDefault();
    addComment();
  })

  // 添加评论
  var addComment = function() {
    var name = $('.js-name').val();
    var comment = $('.js-comment').val();

    $.ajax({
      'type' : 'POST',
      'url'  : '/home/blog/addComment/',
      'data' : sprintf('name=%s&comment=%s&id=%s', encodeURIComponent(name), encodeURIComponent(comment), encodeURIComponent(window.location.href)),
      'success' : function(data) {
          initComment();
          $('.js-name').val('');
          $('.js-comment').val('');
      }
    })
  }
});

</script>
<script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script>

</body>
</html>
