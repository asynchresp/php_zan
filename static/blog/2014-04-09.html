<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />

<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/blog.css" type="text/css"/>

<title>awk脚本进阶攻略</title>
<meta name="keywords" content="awk详解,awk脚本,awk进阶攻略,linux命令,awk实例">
<meta name="description" content="awk详解,awk脚本,awk进阶攻略,linux命令,awk实例">
<script type="text/javascript">
var _speedMark = new Date();
</script>
</head>

<body>
<div class="navbar navbar-fixed-top">
  <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
        <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav ml90">
          <li data-slide="1" class="col-xs-4"><a href="/"  id="menu-link-1"><span class="glyphicon glyphicon-home"></span>首页</a></li>
          <li data-slide="2" class="col-xs-4 active"><a href="/blog/" id="menu-link-2"><span class="glyphicon glyphicon-book"></span>博客</a></li>
          <li data-slide="3" class="col-xs-4"><a href="/team/" id="menu-link-3" target="_blank"><span class="glyphicon glyphicon-user"></span>团队</a></li>
        </ul>
      <div class="row">
        <div class="col-xs-4 active-menu"></div>
      </div>
          
      </div>
    </div>
</div>
<div class="content-title"><h1 class="title glyphicon glyphicon-leaf">awk脚本进阶攻略<span class="view glyphicon glyphicon-eye-open"></span><span class="time glyphicon glyphicon-time"></span></h1></div>

<div class="content">
	<!---title:awk脚本进阶攻略-->
<!---keywords:awk详解,awk脚本,awk进阶攻略,linux命令,awk实例-->

<p>前面介绍了<a href="http://www.huamanshu.com/blog/2014-04-03.html">文本处理神器之awk</a>以及<a href="http://www.huamanshu.com/blog/2014-04-07.html">翻译和详解gawk 4.0.0特性</a>，这两个已经基本了解到awk的使用技巧，或者学习能力强者早已渴望把awk发挥到极致，我也希望能如此。</p>
<p>所谓的成就感，应该是指每做一件事情都能做好，而且做到极致，这种成功的感觉能复制，它会使你相好要做下一件事的时候，已经看到它最后完成的样子。</p>
<p>以一个简单的例子开始，试着删除除了特定文件之外的所有文件。网上有很多例子，自行搜索，有<code>grep -v</code>的，也有保存副本的。我来介绍些很有意思的命令组合，先看下大概的文件情况：</p>
<pre><code>$ ls
FPAT  func  iis  lls  n  nn  pipe  sub  xx  yy</code></pre>
<p>现在要删除除了n之外的所有文件，这种情况是最简单的，<code>rm -f !(n)</code>即可解决，这样<code>ls | grep -v &quot;^n$&quot; | rm -rf</code>也可以。</p>
<p>删除除了n打头或者x打头之外的所有文件，上述的<code>rm</code>一条语句已经不能解决了，开始介绍使用awk脚本吧，因为我已经深深的爱上了它，请允许我对它的溺爱。</p>
<pre><code>$ cat ../ls_rm.awk 
#!/usr/bin/awk -f
# use: ls | awk -f ls_rm.awk

$0 !~ &quot;^n|^x&quot; {
    printf(&quot;rm -rf %s\n&quot;, $0) | &quot;sh&quot;
}

$ ls | awk -f ../ls_rm.awk ; ls
n  nn  xx</code></pre>
<p>实现的原理也很简单，筛选合理的文件列表，拼接出删除语句，通过<code>sh</code>管道来删除。这个只是初步实现了功能，但我们可以让它稍微灵活点，让脚本支持传参，之前在介绍神器的时候已经有使用参数 <code>-v</code>，现在再复现。</p>
<pre><code>...
$0 !~ pregX {
    printf(&quot;rm -rf %s\n&quot;, $0) | &quot;sh&quot;
}

$ ls | awk -vpregX=&quot;^x|^n&quot; -f ../ls_rm.awk ; ls
n  nn  xx</code></pre>
<p><code>-v</code>后面带一个变量名，它将会是整个awk脚本的全局变量，随时随地可以使用。这应该是很好的想法，在我统计一些日志时，它都能非常快速的完成，借用一个工作中的例子来介绍下awk脚本在统计日志的应用。</p>
<blockquote>
<p>WARNING: 04-09 15:38:06 openapi * 3628 [logid=2654850343 filename=/home/users/wushuiyong/xxx.php lineno=118 errno=21034 method=xxxGiftVirtualExchange%3A%3A_formatReturn param=NULL optime=1397029086.54 cli ent_ip=10.xxx local_ip=10.xxx product=ORP subsys=ORP module=openapi uniqid=0 cgid=4106488800 uid=0 errmsg=gift%20insufficient%20GIF T%20INSUFFICIENT]</p>
</blockquote>
<p>日志格式如上面，找出错误方法，以及数量。但字段不稳定，method可能是11字段，也可能在14字段，也可能不出现，但一旦出现method，后面必跟参数param，所以在WARNING中匹配method(.*)param即可。</p>
<pre><code>$cat method.awk
#!/bin/awk -f
# use:awk -vs=&quot;method=&quot; -ve=&quot;param=&quot; -f method.awk xxx.wf.log
# awk v 3.1.3

BEGIN {
    re = sprintf(&quot;%s(.*)%s&quot;, s, e);
    printf(&quot;错误方法\t\t\t数量\n&quot;);
    printf(&quot;---------------------------------------------------------\n&quot;);
}
/WARNING.*method/ {
    match($0, re, arr);
    list[arr[1]]++;
}
END {
    for (k in list) printf(&quot;%s %d\n&quot;, k, list[k]);
}
$ awk -vs=&quot;method=&quot; -ve=&quot;param=&quot; -f method.awk log
    错误方法            数量
---------------------------------------------------------
xxxGiftVirtualExchange%3A%3A_formatReturn  8
yyy%3A%3AgiftVirtualExchange  6
zzz%3A%3A_onCommit  1</code></pre>
<p>这日志统计脚本没有什么理解难度，都是之前介绍过后知识，但对于我们在开发和线上排错，它就是一个好帮手。当帮手越多，就越有信心解决问题，角度和视野就越宽广。</p>
</div>

<hr class="blog-hr">

<div class="container blog-container prev-next-box">
  <ul class="pager">
    <li class="previous"><a href="javascript:void(0);" id="prev">&larr; Older</a></li>
    <li class="next"><a href="javascript:void(0);" id="next">Newer &rarr;</a></li>
  </ul>
</div>

<div class="content" data-slide="1">
	<div class="blog-container">
		<div id="home-row-1" class="clearfix">
			<div id="comments"></div>
		</div>
	</div>
</div>

<div class="container blog-container comment-box">
		<form class="form-horizontal" role="form">
	  <div class="form-group">
	    <div class="col-sm-3">
	      <input type="text" class="form-control js-name" placeholder="名字不重要">
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <textarea class="form-control inputComment js-comment" placeholder="深有感触，写点我的想法"> </textarea>
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <button type="submit" class="btn btn-default js-submit">发表评论</button>
	    </div>
	  </div>
	</form>
</div>
<!-- <div id="blog-footer"><a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="weibo">微博</a> | <a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="glyphicon glyphicon-envelope email-footer">wushuiyong@huamanshu.com</a> </div> -->
<div id="blog-footer">©2014 huamanshu. All rights reserved</div><div class="hide" style="display:none"><script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script></div>
<script src="/static/js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="/static/js/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/static/js/script.js" type="text/javascript"></script>
<script>
$(document).ready(function(e) {
  var lis = $('.nav > li');
  menu_focus( lis[1], 1 );
  
  var sprintf = function() {
      var arg = arguments,
          str = arg[0] || '',
          i, n;
      for (i = 1, n = arg.length; i < n; i++) {
          str = str.replace(/%s/, arg[i]);
      }
      return str;
  }

  // 初始化评论
  var initComment = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getComment/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          var tpl = '';
          for (key in data.comments) {
              var c = data.comments[key];
              tpl += sprintf("<blockquote><p><em>%s</em>%s</p></blockquote>", c.name, c.comment);
          }
          $('#comments').html(tpl).show();
      }
    })
  }
  initComment();

  // 初始化浏览次数
  var initViewCount = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/viewCount/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          $('.time').text(data.time);
          $('.view').text(data.view);
      }
    });
  }
  initViewCount();

  // 获取上一篇下一篇
  var initNextPrev = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getNextPrev/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
        var re = /\/index\d.html/
        var nTitle = re.test(data.n.url) ? '下一页' : data.n.title;
        var pTitle = re.test(data.p.url) ? '上一页' : data.p.title;
        data.n ? $('#next').attr('href', data.n.url).html(nTitle + ' &rarr;') : $('#next').hide();
        data.p ? $('#prev').attr('href', data.p.url).html('&larr; ' + pTitle) : $('#prev').hide();
      }
    });
  }
  initNextPrev();

  // 写完点提交或者ctrl+enter
  if (event.ctrlKey && event.keyCode == '13') {
    addComment();
  }
  $('.js-submit').click(function(e) {
    e.preventDefault();
    addComment();
  })

  // 添加评论
  var addComment = function() {
    var name = $('.js-name').val();
    var comment = $('.js-comment').val();

    $.ajax({
      'type' : 'POST',
      'url'  : '/home/blog/addComment/',
      'data' : sprintf('name=%s&comment=%s&id=%s', encodeURIComponent(name), encodeURIComponent(comment), encodeURIComponent(window.location.href)),
      'success' : function(data) {
          initComment();
          $('.js-name').val('');
          $('.js-comment').val('');
      }
    })
  }
});

</script>
<script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script>

</body>
</html>
