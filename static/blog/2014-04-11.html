<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />

<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/blog.css" type="text/css"/>

<title>脚本，联合起来吧</title>
<meta name="keywords" content="shell脚本,expect脚本,awk脚本,日志分析">
<meta name="description" content="shell脚本,expect脚本,awk脚本,日志分析">
<script type="text/javascript">
var _speedMark = new Date();
</script>
</head>

<body>
<div class="navbar navbar-fixed-top">
  <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
        <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav ml90">
          <li data-slide="1" class="col-xs-4"><a href="/"  id="menu-link-1"><span class="glyphicon glyphicon-home"></span>首页</a></li>
          <li data-slide="2" class="col-xs-4 active"><a href="/blog/" id="menu-link-2"><span class="glyphicon glyphicon-book"></span>博客</a></li>
          <li data-slide="3" class="col-xs-4"><a href="/team/" id="menu-link-3" target="_blank"><span class="glyphicon glyphicon-user"></span>团队</a></li>
        </ul>
      <div class="row">
        <div class="col-xs-4 active-menu"></div>
      </div>
          
      </div>
    </div>
</div>
<div class="content-title"><h1 class="title glyphicon glyphicon-leaf">脚本，联合起来吧<span class="view glyphicon glyphicon-eye-open"></span><span class="time glyphicon glyphicon-time"></span></h1></div>

<div class="content">
	<!---title:脚本，联合起来吧-->
<!---keywords:shell脚本,expect脚本,awk脚本,日志分析-->
    
<p>脚本总是能给人别样的惊喜，无论是在面对繁杂的小需求，还是想实现一个传说中的智能。感谢linux给我们提供了各种工具，只要对各个命令工具有足够了解，应付工作中的问题，完全没有问题。类似切换hosts，自动登录服务器。最好的做法就是让脚本联合起来，本来各自为王的他们利用自己最大的优势来为一个目标贡献，像expect做交互，awk字段切分，联合起来吧！</p>
<p>之前同事上线了个新功能，突然PM怀疑有bug，看到量在掉，于是开发就得开始忙了，同时打开n个终端，登录所有线上机器，对日志进行grep。非得这么做的原因是log平台正在迁移，没法使用，反正我还没有使用过。为了方便排查线上机器错误日志，解决同时登录多台服务器查log问题，对于这种原始做法应当优化。要坚持不用人工处理的都要实现自动化，这是一个很有意思的事。</p>
<p>脚本也很简单，它主要就是实现两个事情，首先把log日志下载到本地，然后做日志分析，这样分析脚本产生的压力就不会影响到线上机器了。</p>
<div class="figure">
<img src="/static/images/upload/20140412233116.png" alt="那么看下一个使用demo吧" /><p class="caption">那么看下一个使用demo吧</p>
</div>
<p id="section"></p>
<pre><code># File Name: analyseLog.sh
# Author: wushuiyong
# mail: wushuiyong@huamanshu.com
# use: sh analyseLog.sh
# 用途：下载使用者选定的单元、服务器、模块、时间对应的日志文件，并进行自定义日志分析脚本
# Created Time: Fri 11 Apr 2014 10:14:50 AM CST
#########################################################################
#!/bin/bash


# 下载日志文件
function download() {
    currentDate=`date +%Y%m%d%H -d now`
    read -p &quot;请输入模块名(如 $project )：&quot; logModule
    read -p &quot;请输入日志时间(当前时间 ${currentDate} )：&quot; logDate
    echo -e  &quot;\033[32m开始下载日志文件...\033[0m&quot;;
    # 循环服务器下载日志文件
    while [ $# -gt 0 ] 
    do  
        machine=$1
        expect downloadLog.exp $machine ${logModule} ${logModule}.log.wf.${logDate};
        shift
    done
    echo -e  &quot;\033[32m日志文件下载完毕\033[0m&quot;;
}

# 机器选择和下载日志
function machineAndLog() {
    i=0
    echo &quot;[all]all openapi machines&quot;
    # 输出机器给用户选择
    for machine in ${machines[@]};
    do
        echo &quot;[${i}]${machine}&quot;
        ((i++))
    done

    read -p &quot;请选择单台机器或全部机器：&quot; machineNo
    # 开始下载日志文件
    if [ $machineNo = &quot;all&quot; ];then
        echo -e &quot;\033[32m已选全部机器\033[0m&quot;
        download ${machines[@]} 
    else
        echo -e &quot;\033[32m已选${machines[$machineNo]}\033[0m&quot;
        download ${machines[$machineNo]}
    fi

    # 自定义错误分析脚本（分析报错方法和数量)
    echo -e  &quot;\033[32m开始错误分析...&quot;;
    awk  -vs=&quot;method&quot; -ve=&quot;param&quot; -f methodError.awk *log.wf*
    echo -e  &quot;---------------------------------------------------------\033[0m&quot;;
}                                                                                                                                                

# 项目选择
while :
do
if read -p &quot;请选择服务单元[o]openapi, [c]commit：&quot; project
then
    case $project in
        o|O)
            # 配置
            project=&quot;openapi&quot;
            echo -e &quot;\033[32m已选${project}服务单元\033[0m&quot;
            # 机器配置
            machines=(hz01-xxx-bao00.hz01 hz01-xxx-bao01.hz01 hz01-xxx-bao02.hz01 hz01-xxx-bao03.hz01 cq02-xxx-bao00.cq02 cq02-xxx-bao01.cq02 cq02-xxx-bao02.cq02);
            machineAndLog
            break
            ;;
        c|C)
            project=&quot;commit&quot;
            echo -e &quot;\033[32m已选${project}项目\033[0m&quot;
            machines=(hz01-xxx-bao04.hz01 cq02-xxx-bao04.cq02)
            machineAndLog 
            break
            ;;
        *)
            echo &quot;未识别配置&quot;                                                                                                                    
            continue
    esac
fi
done</code></pre>
<p>shell脚本变量分三种：系统变量，环境变量和用户变量。这个脚本介绍了下系统变量，即$#，<span class="math">1，<em>分</em><em>别</em><em>表</em><em>示</em><em>参</em><em>数</em><em>个</em><em>数</em><em>和</em><em>第</em><em>一</em><em>个</em><em>参</em><em>数</em>。<em>上</em><em>面</em><em>定</em><em>义</em><em>的</em></span>project、<span class="math">$machines变量（或数组）都是用户变量，他们在被unset或者脚本结束之前都是全局有效的，也就是global。当然，如果你想定义一个local变量只有使用范围内的局部变量也是可以的：`local project=&quot;localVar&quot;`即可。至于环境变量如使用的shell路径：$</span>SHELL，特点就是它们都是<code>$</code>开头大写的变量。</p>
<p>也涉及了shell函数的定义和使用，包括传参。shell函数字义和使用稍微有点跟平常接触的语法不太一样，尤其是在需要做参的时候，涉及的问题就是函数定义的时候，没有直接告诉使用者函数接收什么样式参数。最头疼的就是当参数超过两个，且有数组的时候，就很麻烦了。网友的推荐就是尽可能地在一个脚本里完成操作，包括函数定义和使用，使用全局变量代替传参。如果非要传数组的话，我用了一个<code>shift</code>例子简单介绍了函数处理数组参数的问题。<code>shift</code>是一个挺有意思的工具，虽然在其它编程语言中很少使用，而在交互语言中很常见。它的作用就类似数据库的游标一样，改变位置指向下一个。标准的说法就是它会改变位置变量，也就是上面说的系统变量中的<code>$#</code>和<code>$n</code>的指针，每<code>shift</code>一次，<code>$#</code>就减一，<code>$1</code>就会加一指向下一个变量，<code>$2</code>、<code>$3</code>...需要例子详说否？</p>
<pre><code>$ cat shift.sh 
#!/bin/bash
until [ $# = 0 ]
do
    echo &quot;\$1 =&gt; $1, \$2 =&gt; $2, \$# =&gt; $#&quot; 
    shift
done
$ sh shift.sh a b c d
$1 =&gt; a, $2 =&gt; b, $# =&gt; 4
$1 =&gt; b, $2 =&gt; c, $# =&gt; 3
$1 =&gt; c, $2 =&gt; d, $# =&gt; 2
$1 =&gt; d, $2 =&gt; , $# =&gt; 1</code></pre>
<hr />
<p>很简单的一个awk脚本。</p>
<pre><code>#########################################################################
# File Name: methodError.awk
# Author: wushuiyong
# mail: wushuiyong@huamanshu.com
# use:awk -vs=&quot;method&quot; -ve=&quot;param&quot; -f method.awk xxx.wf.log
# 用途：打印日志中错误的方法以及个数
# Created Time: Thu 10 Apr 2014 07:15:00 PM
#########################################################################
#!/bin/awk -f

BEGIN {
    re = sprintf(&quot;%s(.*)%s&quot;, s, e); 
    printf(&quot;---------------------------------------------------------\n&quot;);                                                                       
    printf(&quot;错误方法\t\t\t数量\n&quot;);
    printf(&quot;---------------------------------------------------------\n&quot;);
}
/WARNING.*method/ {
    match($0, re, arr); 
    list[arr[1]]++;
}
END{
    for (k in list) printf(&quot;%s %d\n&quot;, k, list[k]);
}</code></pre>
<hr />
<p>很简单的一个expect脚本。</p>
<pre><code>#########################################################################                                                                        
# File Name: downloadLog.exp
# Author: wushuiyong
# mail: wushuiyong@huamanshu.com
# Created Time: Thu 10 Apr 2014 07:32:00 PM
#########################################################################
#!/home/tools/bin/64/expect

set noahUser &quot;xxx&quot;
set noahPasswd &quot;xxx\n&quot;

set machine [lindex $argv 0]
set module [lindex $argv 1]
set logFile [lindex $argv 2]

# 下载限速10M
spawn scp -l 10000 $noahUser@$machine:~/odp/log/$module/$logFile ${machine}_$logFile 

expect {

    &quot;yes/no&quot; {
        send &quot;yes\n&quot;;exp_continue;
    }   

    &quot;password:&quot; {
        send $noahPasswd;expect eof 
    }   
}</code></pre>
</div>

<hr class="blog-hr">

<div class="container blog-container prev-next-box">
  <ul class="pager">
    <li class="previous"><a href="javascript:void(0);" id="prev">&larr; Older</a></li>
    <li class="next"><a href="javascript:void(0);" id="next">Newer &rarr;</a></li>
  </ul>
</div>

<div class="content" data-slide="1">
	<div class="blog-container">
		<div id="home-row-1" class="clearfix">
			<div id="comments"></div>
		</div>
	</div>
</div>

<div class="container blog-container comment-box">
		<form class="form-horizontal" role="form">
	  <div class="form-group">
	    <div class="col-sm-3">
	      <input type="text" class="form-control js-name" placeholder="名字不重要">
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <textarea class="form-control inputComment js-comment" placeholder="深有感触，写点我的想法"> </textarea>
	    </div>
	  </div>
	  <div class="form-group">
	    <div class="col-sm-10">
	      <button type="submit" class="btn btn-default js-submit">发表评论</button>
	    </div>
	  </div>
	</form>
</div>
<!-- <div id="blog-footer"><a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="weibo">微博</a> | <a href="http://e.weibo.com/csdnsupport/profile" target="_blank" class="glyphicon glyphicon-envelope email-footer">wushuiyong@huamanshu.com</a> </div> -->
<div id="blog-footer">©2014 huamanshu. All rights reserved</div><div class="hide" style="display:none"><script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script></div>
<script src="/static/js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="/static/js/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="/static/js/script.js" type="text/javascript"></script>
<script>
$(document).ready(function(e) {
  var lis = $('.nav > li');
  menu_focus( lis[1], 1 );
  
  var sprintf = function() {
      var arg = arguments,
          str = arg[0] || '',
          i, n;
      for (i = 1, n = arg.length; i < n; i++) {
          str = str.replace(/%s/, arg[i]);
      }
      return str;
  }

  // 初始化评论
  var initComment = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getComment/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          var tpl = '';
          for (key in data.comments) {
              var c = data.comments[key];
              tpl += sprintf("<blockquote><p><em>%s</em>%s</p></blockquote>", c.name, c.comment);
          }
          $('#comments').html(tpl).show();
      }
    })
  }
  initComment();

  // 初始化浏览次数
  var initViewCount = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/viewCount/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
          $('.time').text(data.time);
          $('.view').text(data.view);
      }
    });
  }
  initViewCount();

  // 获取上一篇下一篇
  var initNextPrev = function() {
    $.ajax({
      'type' : 'GET',
      'url'  : '/home/blog/getNextPrev/',
      'data' : 'id=' + encodeURIComponent(window.location.href),
      'success' : function(data) {
        var re = /\/index\d.html/
        var nTitle = re.test(data.n.url) ? '下一页' : data.n.title;
        var pTitle = re.test(data.p.url) ? '上一页' : data.p.title;
        data.n ? $('#next').attr('href', data.n.url).html(nTitle + ' &rarr;') : $('#next').hide();
        data.p ? $('#prev').attr('href', data.p.url).html('&larr; ' + pTitle) : $('#prev').hide();
      }
    });
  }
  initNextPrev();

  // 写完点提交或者ctrl+enter
  if (event.ctrlKey && event.keyCode == '13') {
    addComment();
  }
  $('.js-submit').click(function(e) {
    e.preventDefault();
    addComment();
  })

  // 添加评论
  var addComment = function() {
    var name = $('.js-name').val();
    var comment = $('.js-comment').val();

    $.ajax({
      'type' : 'POST',
      'url'  : '/home/blog/addComment/',
      'data' : sprintf('name=%s&comment=%s&id=%s', encodeURIComponent(name), encodeURIComponent(comment), encodeURIComponent(window.location.href)),
      'success' : function(data) {
          initComment();
          $('.js-name').val('');
          $('.js-comment').val('');
      }
    })
  }
});

</script>
<script type="text/javascript" src="http://hm.baidu.com/h.js?fb1a70589b6397ff055728e0196175d5"></script>

</body>
</html>
